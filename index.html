<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sobriety Tracker</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyC3Ym6AFZ510Apn3Fe5rjwCGjL8dbV4nJw",
  authDomain: "sobriety-tracker-53d88.firebaseapp.com",
  projectId: "sobriety-tracker-53d88",
  storageBucket: "sobriety-tracker-53d88.firebasestorage.app",
  messagingSenderId: "383822240935",
  appId: "1:383822240935:web:4b195d4594215f3d3acf82",
  measurementId: "G-Y9GWV4PL75",
  databaseURL: "https://sobriety-tracker-53d88-default-rtdb.firebaseio.com/"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

const users = [
  { id:"shiv", name:"Shiv", color:"#f97316" },
  { id:"aniruddh", name:"Aniruddh", color:"#10b981" },
  { id:"garvit", name:"Garvit", color:"#3b82f6" },
  { id:"prajwal", name:"Prajwal", color:"#8b5cf6" },
  { id:"satwik", name:"Satwik", color:"#ec4899" }
];

const motivationalQuotes = {
  smoking: [
    "Every smoke-free second counts! üå±",
    "Your lungs will thank you. üí®",
    "Stay strong, one day at a time. üí™"
  ],
  alcohol: [
    "Every sober moment is victory! üèÜ",
    "Clarity is priceless. ‚ú®",
    "Your future self is proud. üåü"
  ]
};

let currentUser=null;
let timers={};
let intervalHandles={};
let activeTab=users[0].id;
let viewMode="individual"; // or "global"

function formatTime(ms){
  const days=Math.floor(ms/(1000*60*60*24));
  const hours=Math.floor((ms/(1000*60*60))%24);
  const minutes=Math.floor((ms/(1000*60))%60);
  const seconds=Math.floor((ms/1000)%60);
  return `${days}d ${hours}h ${minutes}m ${seconds}s`;
}

onAuthStateChanged(auth,user=>{
  if(user){
    currentUser=user;
    document.getElementById("loginSection").style.display="none";
    document.getElementById("appSection").style.display="block";
    loadTimers();
  } else {
    currentUser=null;
    document.getElementById("loginSection").style.display="block";
    document.getElementById("appSection").style.display="none";
    clearAllIntervals();
  }
});

window.login=()=>{ 
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  signInWithEmailAndPassword(auth,email,password).catch(err=>alert("Login failed: "+err.message));
}

window.logout=()=>signOut(auth);

function clearAllIntervals(){
  Object.values(intervalHandles).forEach(h=>clearInterval(h));
  intervalHandles={};
}

function loadTimers(){
  const timersRef=ref(db,"timers/");
  onValue(timersRef,snapshot=>{
    timers=snapshot.val()||{};
    renderView();
  });
}

function switchTab(userID){ activeTab=userID; renderView(); }
function switchView(mode){ viewMode=mode; renderView(); }

function renderView(){
  if(viewMode==="global"){ renderGlobalDashboard(); }
  else{ renderIndividualTab(); renderTabs(); }
}

// --- Render Tabs ---
function renderTabs(){
  const tabContainer=document.getElementById("tabs");
  tabContainer.innerHTML="";
  users.forEach(u=>{
    const btn=document.createElement("button");
    btn.textContent=u.name;
    btn.className=`px-4 py-2 rounded-t-lg ${activeTab===u.id?"bg-blue-500 text-white":"bg-gray-300 text-gray-800"} hover:bg-blue-400`;
    btn.onclick=()=>switchTab(u.id);
    tabContainer.appendChild(btn);
  });
}

// --- Render Individual Tab ---
function renderIndividualTab(){
  clearAllIntervals();
  const container=document.getElementById("timers");
  container.innerHTML="";
  const userData=timers[activeTab]||{};
  const userInfo=users.find(u=>u.id===activeTab);

  const card=document.createElement("div");
  card.className="bg-white rounded-xl shadow-md p-4 flex flex-col items-center w-full md:w-80";

  // Avatar
  const avatar=document.createElement("div");
  avatar.className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg mb-2";
  avatar.style.backgroundColor=userInfo.color;
  avatar.textContent=userInfo.name.charAt(0);
  card.appendChild(avatar);

  // Name
  const nameEl=document.createElement("h2");
  nameEl.className="text-xl font-bold mb-4";
  nameEl.textContent=userInfo.name;
  card.appendChild(nameEl);

  ["smoking","alcohol"].forEach(type=>{
    const timerWrapper=document.createElement("div");
    timerWrapper.className="bg-gray-100 rounded-lg p-3 w-full mb-3";

    const label=document.createElement("div");
    label.textContent=type==="smoking"?"üö¨ Smoking":"üç∑ Alcohol";
    label.className="font-semibold mb-1";
    timerWrapper.appendChild(label);

    const timerDisplay=document.createElement("div");
    timerDisplay.className="text-blue-600 text-lg font-mono mb-1";
    timerWrapper.appendChild(timerDisplay);

    const quoteEl=document.createElement("div");
    quoteEl.className="text-sm text-purple-700 mb-2";
    timerWrapper.appendChild(quoteEl);

    let lastTime=userData[type]?.lastTime||null;
    function updateTimer(){
      if(lastTime){
        const diff=Date.now()-lastTime;
        timerDisplay.textContent=formatTime(diff);
      }else{ timerDisplay.textContent="Not set yet"; }
    }
    updateTimer();
    intervalHandles[activeTab+"_"+type]=setInterval(updateTimer,1000);

    if(currentUser && currentUser.uid===activeTab){
      const input=document.createElement("input");
      input.type="datetime-local";
      input.className="border rounded p-1 w-full mb-1";
      input.max=new Date().toISOString().slice(0,16);

      const btn=document.createElement("button");
      btn.textContent="Update Last Time";
      btn.className="bg-blue-500 text-white px-2 py-1 rounded w-full hover:bg-blue-600 mb-2";
      btn.onclick=()=>{
        if(!input.value) return alert("Select date & time!");
        const chosenTime=new Date(input.value).getTime();
        if(chosenTime>Date.now()) return alert("Future date not allowed!");
        set(ref(db,"timers/"+currentUser.uid+"/"+type),{lastTime:chosenTime}).then(()=>{
          lastTime=chosenTime;
          quoteEl.textContent=motivationalQuotes[type][Math.floor(Math.random()*motivationalQuotes[type].length)];
        });
      };
      timerWrapper.appendChild(input);
      timerWrapper.appendChild(btn);
    }

    card.appendChild(timerWrapper);
  });

  container.appendChild(card);
}

// --- Render Global Dashboard ---
function renderGlobalDashboard(){
  clearAllIntervals();
  const container=document.getElementById("timers");
  container.innerHTML="";
  users.forEach(u=>{
    const userData=timers[u.id]||{};
    const card=document.createElement("div");
    card.className="bg-white rounded-xl shadow-md p-4 flex flex-col items-center w-full md:w-80 mb-4";

    const avatar=document.createElement("div");
    avatar.className="w-12 h-12 rounded-full flex items-center justify-center text-white font-bold text-lg mb-2";
    avatar.style.backgroundColor=u.color;
    avatar.textContent=u.name.charAt(0);
    card.appendChild(avatar);

    const nameEl=document.createElement("h2");
    nameEl.className="text-xl font-bold mb-4";
    nameEl.textContent=u.name;
    card.appendChild(nameEl);

    ["smoking","alcohol"].forEach(type=>{
      const timerWrapper=document.createElement("div");
      timerWrapper.className="bg-gray-100 rounded-lg p-3 w-full mb-3";

      const label=document.createElement("div");
      label.textContent=type==="smoking"?"üö¨ Smoking":"üç∑ Alcohol";
      label.className="font-semibold mb-1";
      timerWrapper.appendChild(label);

      const timerDisplay=document.createElement("div");
      timerDisplay.className="text-blue-600 text-lg font-mono mb-1";
      timerWrapper.appendChild(timerDisplay);

      let lastTime=userData[type]?.lastTime||null;
      function updateTimer(){
        if(lastTime){
          const diff=Date.now()-lastTime;
          timerDisplay.textContent=formatTime(diff);
        }else{ timerDisplay.textContent="Not set yet"; }
      }
      updateTimer();
      intervalHandles[u.id+"_"+type]=setInterval(updateTimer,1000);

      card.appendChild(timerWrapper);
    });

    container.appendChild(card);
  });
}
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{background:linear-gradient(135deg,#6dd5ed,#2193b0); font-family:Segoe UI, sans-serif;}
h1{text-align:center;color:white;font-size:2.5rem;margin-bottom:1rem;}
#tabs button{transition:all 0.2s;}
</style>
</head>
<body class="flex flex-col items-center p-6">
<h1>üö≠ Sobriety Tracker</h1>

<!-- Login -->
<div id="loginSection" class="bg-white p-6 rounded-xl shadow-md w-80 mb-6">
  <h2 class="text-xl font-semibold mb-4 text-center">Login</h2>
  <input id="email" type="email" placeholder="Email" class="border rounded p-2 w-full mb-2">
  <input id="password" type="password" placeholder="Password" class="border rounded p-2 w-full mb-4">
  <button onclick="login()" class="bg-blue-500 text-white w-full py-2 rounded-lg hover:bg-blue-600">Login</button>
</div>

<!-- App Section -->
<div id="appSection" style="display:none;" class="flex flex-col items-center w-full max-w-5xl">
  <div class="flex gap-2 mb-4 flex-wrap justify-center">
    <button onclick="switchView('individual')" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Individual View</button>
    <button onclick="switchView('global')" class="bg-gray-200 px-3 py-1 rounded hover:bg-gray-300">Global Dashboard</button>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Logout</button>
  </div>
  <div id="tabs" class="flex gap-2 mb-4 flex-wrap justify-center"></div>
  <div id="timers" class="flex flex-col items-center w-full"></div>
</div>
</body>
</html>
